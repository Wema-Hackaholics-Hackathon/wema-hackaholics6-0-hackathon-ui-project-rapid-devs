<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow IT Admin Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .add-block-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .method-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .method-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .method-checkbox:hover {
            background: #e9ecef;
        }
        
        .method-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        
        .risk-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .risk-display {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .blocked-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
        }
        
        .blocked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .blocked-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .domain-info {
            flex: 1;
        }
        
        .domain-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .domain-methods {
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .risk-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .risk-high { background: #ffe5e5; color: #e74c3c; }
        .risk-medium { background: #fff3cd; color: #f39c12; }
        .risk-low { background: #d4edda; color: #27ae60; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .category-select {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .ai-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Shadow IT Admin Control Panel</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalBlocked">0</div>
                    <div class="stat-label">Sites Blocked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeRules">0</div>
                    <div class="stat-label">Active Rules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="aiStatus">OFF</div>
                    <div class="stat-label">AI Mode</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="requestsToday">0</div>
                    <div class="stat-label">Requests Today</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-danger" id="errorAlert"></div>
        
        <div class="grid">
            <!-- Add Blocking Rules Panel -->
            <div class="panel">
                <h2>‚ûï Add Blocking Rules</h2>
                
                <div class="ai-toggle">
                    <span>ü§ñ AI Risk Assessment</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aiModeToggle">
                        <span class="slider"></span>
                    </label>
                    <span id="aiStatus">Disabled</span>
                </div>
                
                <div class="add-block-form">
                    <div class="input-group">
                        <input type="text" id="domainInput" placeholder="Enter domain (e.g., facebook.com)">
                    </div>
                    
                    <select class="category-select" id="categorySelect">
                        <option value="social_media">Social Media</option>
                        <option value="file_sharing">File Sharing</option>
                        <option value="cloud_storage">Cloud Storage</option>
                        <option value="ai_tools">AI Tools</option>
                        <option value="collaboration">Collaboration</option>
                        <option value="streaming">Streaming</option>
                        <option value="custom">Custom</option>
                    </select>
                    
                    <div>
                        <label>Block Methods:</label>
                        <div class="method-selector">
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="GET" checked>
                                <span>GET</span>
                            </label>
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="POST" checked>
                                <span>POST</span>
                            </label>
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="PUT">
                                <span>PUT</span>
                            </label>
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="DELETE">
                                <span>DELETE</span>
                            </label>
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="HEAD">
                                <span>HEAD</span>
                            </label>
                            <label class="method-checkbox">
                                <input type="checkbox" name="method" value="OPTIONS">
                                <span>OPTIONS</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label>Risk Level (for non-AI mode):</label>
                        <input type="range" class="risk-slider" id="riskSlider" min="1" max="100" value="50">
                        <div class="risk-display">
                            <span>Low</span>
                            <span id="riskValue">50</span>
                            <span>High</span>
                        </div>
                    </div>
                    
                    <input type="text" id="reasonInput" placeholder="Reason for blocking (optional)">
                    
                    <button class="btn btn-primary" onclick="addBlockRule()">
                        Add Blocking Rule
                    </button>
                </div>
                
                <h3 style="margin-top: 30px;">‚ö° Quick Block Templates</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-danger" onclick="blockAllSocialMedia()">Block All Social Media</button>
                    <button class="btn btn-danger" onclick="blockAllFileSharing()">Block File Sharing</button>
                    <button class="btn btn-danger" onclick="blockAllAI()">Block AI Tools</button>
                    <button class="btn btn-danger" onclick="blockAllStreaming()">Block Streaming</button>
                </div>
            </div>
            
            <!-- Currently Blocked Sites Panel -->
            <div class="panel">
                <h2>üö´ Currently Blocked Sites</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="filterBlocked('all')">All</div>
                    <div class="tab" onclick="filterBlocked('high')">High Risk</div>
                    <div class="tab" onclick="filterBlocked('medium')">Medium Risk</div>
                    <div class="tab" onclick="filterBlocked('low')">Low Risk</div>
                </div>
                
                <div class="blocked-list" id="blockedList">
                    <!-- Dynamically populated -->
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="exportRules()">üì• Export Rules</button>
                    <button class="btn btn-primary" onclick="importRules()">üì§ Import Rules</button>
                    <button class="btn btn-danger" onclick="clearAllRules()">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
        
        <!-- Access Requests Panel -->
        <div class="panel" style="margin-top: 30px;">
            <h2>üìã Access Requests</h2>
            <div id="accessRequests">
                <!-- Dynamically populated with pending access requests -->
            </div>
        </div>
        
        <!-- Back to Dashboard -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="/" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>
    
    <script>
        // Load current blocked sites
        let blockedSites = [];
        let aiModeEnabled = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadBlockedSites();
            updateStats();
            setInterval(updateStats, 5000); // Update every 5 seconds
            
            // Risk slider
            document.getElementById('riskSlider').addEventListener('input', (e) => {
                document.getElementById('riskValue').textContent = e.target.value;
            });
            
            // AI mode toggle
            document.getElementById('aiModeToggle').addEventListener('change', (e) => {
                aiModeEnabled = e.target.checked;
                document.getElementById('aiStatus').textContent = aiModeEnabled ? 'Enabled' : 'Disabled';
                localStorage.setItem('aiMode', aiModeEnabled);
                showAlert('success', `AI Mode ${aiModeEnabled ? 'Enabled' : 'Disabled'}`);
            });
        });
        
        async function loadBlockedSites() {
            try {
                const response = await fetch('/api/blocked-sites');
                blockedSites = await response.json();
                renderBlockedList(blockedSites);
            } catch (error) {
                console.error('Error loading blocked sites:', error);
            }
        }
        
        function renderBlockedList(sites) {
            const listEl = document.getElementById('blockedList');
            if (!sites || sites.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No sites currently blocked</p>';
                return;
            }
            
            listEl.innerHTML = sites.map(site => `
                <div class="blocked-item">
                    <div class="domain-info">
                        <div class="domain-name">${site.domain}</div>
                        <div class="domain-methods">Methods: ${site.methods.join(', ')}</div>
                        <div class="domain-methods">Category: ${site.category || 'Custom'}</div>
                        ${site.reason ? `<div class="domain-methods">Reason: ${site.reason}</div>` : ''}
                    </div>
                    <span class="risk-badge risk-${getRiskLevel(site.risk_score)}">
                        Risk: ${site.risk_score}/100
                    </span>
                    <button class="btn btn-danger" onclick="removeBlock('${site.domain}')">
                        Remove
                    </button>
                </div>
            `).join('');
        }
        
        function getRiskLevel(score) {
            if (score >= 70) return 'high';
            if (score >= 40) return 'medium';
            return 'low';
        }
        
        async function addBlockRule() {
            const domain = document.getElementById('domainInput').value.trim();
            const category = document.getElementById('categorySelect').value;
            const methods = Array.from(document.querySelectorAll('input[name="method"]:checked'))
                .map(cb => cb.value);
            const riskScore = document.getElementById('riskSlider').value;
            const reason = document.getElementById('reasonInput').value.trim();
            
            if (!domain) {
                showAlert('danger', 'Please enter a domain');
                return;
            }
            
            if (methods.length === 0) {
                showAlert('danger', 'Please select at least one method to block');
                return;
            }
            
            try {
                const response = await fetch('/api/block-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain,
                        category,
                        methods,
                        risk_score: parseInt(riskScore),
                        reason,
                        use_ai: aiModeEnabled
                    })
                });
                
                if (response.ok) {
                    showAlert('success', `Successfully blocked ${domain}`);
                    document.getElementById('domainInput').value = '';
                    document.getElementById('reasonInput').value = '';
                    loadBlockedSites();
                } else {
                    showAlert('danger', 'Failed to add blocking rule');
                }
            } catch (error) {
                showAlert('danger', 'Error adding blocking rule');
            }
        }
        
        async function removeBlock(domain) {
            if (!confirm(`Remove blocking rule for ${domain}?`)) return;
            
            try {
                const response = await fetch('/api/unblock-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                
                if (response.ok) {
                    showAlert('success', `Successfully unblocked ${domain}`);
                    loadBlockedSites();
                }
            } catch (error) {
                showAlert('danger', 'Error removing block');
            }
        }
        
        function blockAllSocialMedia() {
            const sites = ['facebook.com', 'twitter.com', 'instagram.com', 'reddit.com', 'youtube.com', 'tiktok.com', 'linkedin.com', 'snapchat.com'];
            blockMultipleSites(sites, 'social_media', 'Social media platform');
        }
        
        function blockAllFileSharing() {
            const sites = ['dropbox.com', 'wetransfer.com', 'mega.nz', 'mediafire.com', '4shared.com', 'sendspace.com'];
            blockMultipleSites(sites, 'file_sharing', 'Unauthorized file sharing');
        }
        
        function blockAllAI() {
            const sites = ['chat.openai.com', 'bard.google.com', 'claude.ai', 'poe.com', 'perplexity.ai'];
            blockMultipleSites(sites, 'ai_tools', 'Potential data exposure to AI');
        }
        
        function blockAllStreaming() {
            const sites = ['netflix.com', 'hulu.com', 'twitch.tv', 'spotify.com', 'soundcloud.com'];
            blockMultipleSites(sites, 'streaming', 'Bandwidth and productivity concerns');
        }
        
        async function blockMultipleSites(sites, category, reason) {
            for (const site of sites) {
                await fetch('/api/block-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: site,
                        category,
                        methods: ['GET', 'POST'],
                        risk_score: 75,
                        reason
                    })
                });
            }
            showAlert('success', `Blocked all ${category.replace('_', ' ')} sites`);
            loadBlockedSites();
        }
        
        function filterBlocked(riskLevel) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (riskLevel === 'all') {
                renderBlockedList(blockedSites);
            } else {
                const filtered = blockedSites.filter(site => getRiskLevel(site.risk_score) === riskLevel);
                renderBlockedList(filtered);
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/admin-stats');
                const stats = await response.json();
                
                document.getElementById('totalBlocked').textContent = stats.total_blocked || 0;
                document.getElementById('activeRules').textContent = stats.active_rules || 0;
                document.getElementById('aiStatus').textContent = stats.ai_enabled ? 'ON' : 'OFF';
                document.getElementById('requestsToday').textContent = stats.requests_today || 0;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        function showAlert(type, message) {
            const alertEl = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
            alertEl.textContent = message;
            alertEl.style.display = 'block';
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 3000);
        }
        
        function exportRules() {
            const dataStr = JSON.stringify(blockedSites, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `blocked_sites_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function importRules() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const text = await file.text();
                const rules = JSON.parse(text);
                
                // Import each rule
                for (const rule of rules) {
                    await fetch('/api/block-site', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(rule)
                    });
                }
                
                showAlert('success', `Imported ${rules.length} rules`);
                loadBlockedSites();
            };
            input.click();
        }
        
        async function clearAllRules() {
            if (!confirm('Are you sure you want to clear ALL blocking rules?')) return;
            
            try {
                const response = await fetch('/api/clear-all-blocks', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showAlert('success', 'All blocking rules cleared');
                    loadBlockedSites();
                }
            } catch (error) {
                showAlert('danger', 'Error clearing rules');
            }
        }
    </script>
</body>
</html>